# PostgreSQL Streaming Replication и Patroni — Шпаргалка

## Streaming Replication (встроенный механизм PostgreSQL)

### Общая идея
Streaming replication — встроенный механизм PostgreSQL для организации реплик.  
Основной сервер (**primary**) пишет изменения в WAL (Write-Ahead Log) и передаёт их по сети на узлы-реплики (**standby**). Реплики применяют WAL и становятся актуальной копией primary.

### Режимы работы
- **Асинхронная репликация**  
  Быстрая, запись подтверждается сразу после фиксации на primary. Реплики могут немного отставать. Возможна потеря последних транзакций при падении primary.
- **Синхронная репликация**  
  Запись подтверждается только после фиксации на одной или нескольких репликах. Гарантируется отсутствие потери данных, но увеличивается задержка при записи.

### Роли
- **Primary** — основной сервер, принимает операции записи.
- **Standby (реплики)** — получают WAL от primary. Обычно доступны для операций чтения (режим hot standby).

### Возможности
- Масштабирование чтения за счёт реплик.
- Повышение отказоустойчивости (наличие standby-копий).

### Ограничения
- Запись возможна только на одном узле (primary).
- Нет автоматического переключения ролей без внешних инструментов.
- Не решает задачу шардинга (горизонтальное масштабирование записи).

---

## Patroni (оркестратор поверх Streaming Replication)

### Общая идея
Patroni — это инструмент для управления PostgreSQL-кластером, основанным на streaming replication.  
Он решает задачу **автоматического failover** и поддерживает высокую доступность кластера.

### Основные компоненты
- **PostgreSQL-инстансы**: один primary и несколько реплик.
- **DCS (Distributed Configuration Store)**: внешнее хранилище для координации (etcd, Consul, ZooKeeper, Kubernetes ConfigMap).
- **Patroni-агенты**: процесс на каждом узле, управляющий PostgreSQL и общающийся с DCS.

### Как работает
1. Patroni запускается на каждом узле и регистрируется в DCS.
2. Узлы выбирают лидера (primary).
3. Остальные узлы становятся репликами через streaming replication.
4. При падении primary Patroni автоматически выбирает новую реплику и промотирует её в primary.
5. Другие реплики перенастраиваются на новый primary.

### Архитектура
Типичная конфигурация:
- Несколько узлов PostgreSQL (1 primary + N реплик).
- Несколько узлов DCS (например, 3 узла etcd для кворума).
- Дополнительный уровень маршрутизации (например, HAProxy или PgBouncer), чтобы приложения подключались всегда к актуальному primary или к репликам.

### Возможности Patroni
- Автоматический failover при падении primary.
- Плановое переключение ролей (switchover).
- Использование replication slots и pg_rewind для устойчивости и быстрой синхронизации узлов.
- REST API для получения статуса кластера и управления.
- Интеграция с балансировщиками нагрузки и пулерами соединений.

### Ограничения
- Требует внешнего DCS для координации.
- Добавляет дополнительный уровень сложности (нужен мониторинг Patroni и DCS).
- Не решает задачи шардинга (масштабирование записи).

---

## Сравнение Streaming Replication и Patroni

| Задача | Streaming Replication | Patroni |
|--------|------------------------|---------|
| Масштабирование чтения | ✅ | ✅ |
| Ручной failover | ✅ | ✅ |
| Автоматический failover | ❌ | ✅ |
| Управление кластером и конфигами | ❌ | ✅ |
| Масштабирование записи (шардинг) | ❌ | ❌ |

---

## Итог
- **Streaming Replication** — встроенный механизм PostgreSQL для организации standby-реплик. Отлично подходит для масштабирования чтения и резервирования, но не поддерживает автоматический failover.
- **Patroni** — надстройка, которая превращает набор PostgreSQL-инстансов с репликацией в полноценный HA-кластер с автоматическим выбором лидера и переключением ролей.  
