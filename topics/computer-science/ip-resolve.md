## Resolve Host -> IP

Процесс resolve доменныех имен обычно начинается с syscall getaddrinfo(), которая делает следующее:

1. Проверка локального кэша:

Система сначала проверяет свой внутренний кэш DNS-записей.  
Если доменное имя уже было разрешено ранее и сохранено в кэше, его IP-адрес возвращается сразу.

Если запись там не найдена:

2. Конфигурация из `/etc/nsswitch.conf`:

Этот файл определяет порядок, в котором система будет искать информацию о доменных именах.  
Строка, отвечающая за разрешение имен, выглядит так:
```
hosts: files dns
```
где:
* `files` указывает на использование `/etc/hosts`;
* `dns` указывает на использование DNS-серверов.

Если в строке указаны другие источники (например, mdns, nis), они также будут проверены в указанном порядке.

3. Проверка файла `/etc/hosts`:

Система проверяет файл `/etc/hosts`, который содержит статические записи сопоставления доменных имен и IP-адресов.

Пример содержимого:
```
127.0.0.1       localhost
192.168.1.100   myserver.local
```

Если доменное имя найдено в этом файле, его IP-адрес возвращается.  
Если запись там не найдена:

4. Конфигурация из `/etc/resolv.conf`:

Система обращается к DNS-серверам, указанным в файле `/etc/resolv.conf`.
Пример содержимого:
```
nameserver 8.8.8.8
nameserver 1.1.1.1
search example.com example.org
options ndots:3
options attempts:5
option: rotate
```
<details><summary markdown="span">описание содержимого:</summary>

* `nameserver` указывает IP-адреса DNS-серверов.
* `search` определяет домены, которые будут автоматически добавляться к относительным (неполным) именам 
(например, `host` -> `host.example.com`), если не удалось выполнить resolve их самих (суффиксы из `search` будут 
по очереди добавляться к относительному имени и пытаться выполнить resolve до тех пор, пока resolve не будет выполнен, 
либо пока они не закончатся);
* `option ndots` устанавливает минимальное число точек в доменном имени, после чего оно считается абслютным (FQDN).  
По умолчанию, имеет значение `1` (максимально допустимое значение `15`).  
В противном случае имя считается относительным (неплоным), как следствие к нему применяется правило из `search` (см. пункт выше);  
Стоит заметить, что доменное имя также считаеся абсолютным (FQDN) если заканчивается точкой, например, `alfabank.ru.`.
* `option: attempt` устанавливает количество попыток выполнения resolve доменного имени в рамках отдельно взятого `nameserver`'а, 
после чего считает сервер недоступным и переход к следующему (если таковой имеется).  
По умолчанию имеет значение `2` (максимально допустимое значение `5`).
которое требуется для автоматического добавления домена (например, `host` -> `host.example.com`).
* `option: rotate` устанавливает механизм использования `nameserver`'ов в порядке round-robin.
По умолчанию, сначала используется первый nameserver из списка, и только если он недоступен, то будет использован второй и так далее.

Стоит заметить, что данный файл автоматически управляется системой (например, при получении DNS серверов по DHCP
система записывает их в данный файл), поэтому его не следует конфигурировать вручную. Если же система использует не
классический DHCP клиент, а тот или иной сетевой менеджер (NetworkManager / systemd-networkd / systemd-resolved), то
данное поведение может быть переопределенно.

DHCP работает следующим образом:
* роутер отправляет DHCP-запрос на свой WAN-интерфейс;
* DHCP-сервер провайдера отвечает пакетом с настройками;
* в этом пакете содержится вся необходимая информация:
  * IP-адрес для WAN-интерфейса роутера;
  * маска подсети;
  * адрес шлюза по умолчанию;
  * DNS-серверы;
  * другие параметры сети.

При этом часть из данных настроек может быть переопределена на уровне роутера (например, можно запретить использовать 
DNS-сервера, полученные по DHCP от провайдера или переопределить DNS сервера, которые следует использовать для 
выполнения resolve всех или некоторых доменных имен).

</details>

5. Ответ от DNS сервер'а

DNS сервера бывают нескольких типов относительно режима работы:
* итеративный - если сервер отвечает за запрашиваемую доменную зону, то он возвращает ответ, иначе возвращает адрес 
DNS-сервера, который обладает более точной информацией;
* рекурсивные - сервер сам выполняет запросы к другим серверам DNS (итеративным), 

Обычно (согласно содержимому `/etc/resolv.conf`) запрос идет к DNS серверу сети провайдера вашего интернета.
